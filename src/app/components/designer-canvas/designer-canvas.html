<p><div class="designer-canvas-container">
  <div 
    class="designer-canvas"
    #canvas
    cdkDropList
    [cdkDropListData]="[]"
    (cdkDropListDropped)="onCanvasDropped($event)"
    (click)="onCanvasClick()">
    
    <!-- Root element content -->
    <div 
      class="canvas-element root-element"
      *ngIf="rootElement$ | async as rootElement"
      [style]="getElementStyles(rootElement)">
      
      <!-- Recursive element rendering -->
      <ng-container *ngTemplateOutlet="elementTemplate; context: { $implicit: rootElement }"></ng-container>
    </div>
    
    <!-- Grid overlay for visual feedback -->
    <div class="grid-overlay" [style.display]="'none'">
      <!-- Grid lines would be drawn here when needed -->
    </div>
    
    <!-- Drop zone indicator -->
    <div class="drop-zone-indicator" [style.display]="'none'">
      Drop here
    </div>
  </div>
  
  <!-- Real-time size display during resize -->
  <div class="size-display" 
       *ngIf="showSizeDisplay"
       [style.left.px]="sizeDisplayX"
       [style.top.px]="sizeDisplayY">
    {{ sizeDisplayText }}
  </div>
</div>

<!-- Template for recursive element rendering -->
<ng-template #elementTemplate let-element>
  <div 
    #elementDiv
    class="canvas-element"
    [class.selected]="isSelected(element)"
    [class.layout-element]="isLayoutElement(element)"
    [style]="getElementStyles(element)"
    [attr.data-element-id]="element.id"
    cdkDrag
    [cdkDragDisabled]="!isSelected(element)"
    (cdkDragStarted)="onDragStarted(element); setElementRef(element, elementDiv)"
    (cdkDragMoved)="onDragMoved(element, $event)"
    (cdkDragEnded)="onDragEnded(element, $event)"
    (click)="onElementClick(element, $event)"
    (mouseover)="onLayoutHover($event, element)"
    (mouseleave)="onLayoutHoverExit(element)"
    [cdkDragData]="element">

    <!-- Drag handle: appears only when selected; covers element so dragging can only start when selected -->
    <div *ngIf="isSelected(element)" class="drag-handle" cdkDragHandle (pointerdown)="$event.stopPropagation()"></div>

    <!-- Element content based on type -->
    <div class="element-content" [ngSwitch]="element.type">
      
      <!-- Label -->
      <span *ngSwitchCase="'Label'" class="element-text">
        {{ element.properties.text || 'Label' }}
      </span>
      
      <!-- Button -->
      <button *ngSwitchCase="'Button'" class="element-button" type="button">
        {{ element.properties.text || 'Button' }}
      </button>
      
      <!-- Entry -->
      <input *ngSwitchCase="'Entry'" 
             class="element-input" 
             type="text" 
             [value]="element.properties.text || ''"
             placeholder="Enter text">
      
      <!-- Editor -->
      <textarea *ngSwitchCase="'Editor'" 
                class="element-textarea"
                [value]="element.properties.text || ''"
                placeholder="Enter text">
      </textarea>
      
      <!-- Image -->
      <div *ngSwitchCase="'Image'" class="element-image">
        <span class="material-icons">image</span>
        <span class="placeholder-text">Image</span>
      </div>
      
      <!-- Frame -->
      <div *ngSwitchCase="'Frame'" class="element-frame">
        <div class="frame-content">
          <!-- Render children for container elements -->
          <ng-container *ngFor="let child of element.children">
            <ng-container *ngTemplateOutlet="elementTemplate; context: { $implicit: child }"></ng-container>
          </ng-container>
        </div>
      </div>
      
      <!-- Layout containers -->
      <div *ngSwitchCase="'StackLayout'" class="element-stack-layout"
           #layoutDiv
           cdkDropList
           [cdkDropListData]="element.children"
           (cdkDropListDropped)="onElementDroppedOnLayout(element, $event)"
           (mouseenter)="setElementRef(element, layoutDiv)">
        <ng-container *ngFor="let child of element.children">
          <ng-container *ngTemplateOutlet="elementTemplate; context: { $implicit: child }"></ng-container>
        </ng-container>
      </div>
      
      <div *ngSwitchCase="'VerticalStackLayout'" class="element-vertical-stack-layout"
           #layoutDiv
           cdkDropList
           [cdkDropListData]="element.children"
           (cdkDropListDropped)="onElementDroppedOnLayout(element, $event)"
           (mouseenter)="setElementRef(element, layoutDiv)">
        <ng-container *ngFor="let child of element.children">
          <ng-container *ngTemplateOutlet="elementTemplate; context: { $implicit: child }"></ng-container>
        </ng-container>
      </div>
      
      <div *ngSwitchCase="'Grid'" class="element-grid"
           #layoutDiv
           cdkDropList
           [cdkDropListData]="element.children"
           (cdkDropListDropped)="onElementDroppedOnLayout(element, $event)"
           (mouseenter)="setElementRef(element, layoutDiv)">
        <!-- Grid visualization -->
        <div *ngIf="shouldShowGrid(element)" class="grid-visualization">
          <ng-container *ngFor="let rowIndex of getRowArray(getGridDimensions(element).rows)">
            <ng-container *ngFor="let colIndex of getColumnArray(getGridDimensions(element).columns)">
              <div class="grid-cell"
                   [style]="getGridCellStyles(element, rowIndex, colIndex)">
              </div>
            </ng-container>
          </ng-container>
        </div>
        
        <!-- Grid children -->
        <ng-container *ngFor="let child of element.children">
          <ng-container *ngTemplateOutlet="elementTemplate; context: { $implicit: child }"></ng-container>
        </ng-container>
      </div>
      
      <div *ngSwitchCase="'AbsoluteLayout'" class="element-absolute-layout"
           #layoutDiv
           cdkDropList
           [cdkDropListData]="element.children"
           (cdkDropListDropped)="onElementDroppedOnLayout(element, $event)"
           (mouseenter)="setElementRef(element, layoutDiv)">
        <ng-container *ngFor="let child of element.children">
          <ng-container *ngTemplateOutlet="elementTemplate; context: { $implicit: child }"></ng-container>
        </ng-container>
      </div>
      
      <div *ngSwitchCase="'ScrollView'" class="element-scroll-view">
        <ng-container *ngFor="let child of element.children">
          <ng-container *ngTemplateOutlet="elementTemplate; context: { $implicit: child }"></ng-container>
        </ng-container>
      </div>
      
      <!-- Default case -->
      <div *ngSwitchDefault class="element-default">
        {{ element.type }}
      </div>
    </div>
    
    <!-- Selection handles -->
    <div class="selection-handles" *ngIf="isSelected(element)">
      <!-- Corner handles (blue) -->
      <div class="handle handle-corner handle-nw" 
           (mousedown)="onResizeStart($event, 'nw', element)"></div>
      <div class="handle handle-corner handle-ne" 
           (mousedown)="onResizeStart($event, 'ne', element)"></div>
      <div class="handle handle-corner handle-sw" 
           (mousedown)="onResizeStart($event, 'sw', element)"></div>
      <div class="handle handle-corner handle-se" 
           (mousedown)="onResizeStart($event, 'se', element)"></div>
      
      <!-- Edge handles (green) -->
      <div class="handle handle-edge handle-n" 
           (mousedown)="onResizeStart($event, 'n', element)"></div>
      <div class="handle handle-edge handle-s" 
           (mousedown)="onResizeStart($event, 's', element)"></div>
      <div class="handle handle-edge handle-w" 
           (mousedown)="onResizeStart($event, 'w', element)"></div>
      <div class="handle handle-edge handle-e" 
           (mousedown)="onResizeStart($event, 'e', element)"></div>
    </div>
  </div>
</ng-template>
